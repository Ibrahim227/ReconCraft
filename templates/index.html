<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Recon Scanner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div class="container py-5">
    <h1 class="mb-4 text-center">üïµÔ∏è Web-based ReconCraft</h1>

    <form id="scan-form" class="card shadow-sm p-4">
      <div class="mb-3">
        <label for="domain" class="form-label">Target Domain</label>
        <input type="text" class="form-control" id="domain" placeholder="example.com" required />
      </div>

      <button type="submit" class="btn btn-primary" id="run-btn">Run Scan</button>
      <button id="suspend-btn">‚è∏Ô∏è Suspend</button>
    </form>

    <div id="loading" class="mt-3" style="display:none;">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Scanning...</span>
      </div>
      <span class="ms-2">Scan in progress, please wait...</span>
    </div>

    <div id="results" class="mt-4" style="display:none;">
      <h3>Scan Results for <span id="result-domain"></span></h3>

      <h5>Passive Subdomains:</h5>
      <ul id="passive-list" class="list-group mb-3"></ul>

      <h5>Active Subdomains:</h5>
      <ul id="active-list" class="list-group"></ul>

      <button id="rescan-btn" class="btn btn-secondary mt-3">Run Another Scan</button>
    </div>
  </div>

  <script>
    const form = document.getElementById('scan-form');
    const runBtn = document.getElementById('run-btn');
    const loadingDiv = document.getElementById('loading');
    const resultsDiv = document.getElementById('results');
    const resultDomainSpan = document.getElementById('result-domain');
    const passiveList = document.getElementById('passive-list');
    const activeList = document.getElementById('active-list');
    const rescanBtn = document.getElementById('rescan-btn');

    let pollInterval = null;

    form.addEventListener('submit', (e) => {
      e.preventDefault();

      const domain = document.getElementById('domain').value.trim();
      if (!domain) return;

      // Disable form and show loading
      runBtn.disabled = true;
      loadingDiv.style.display = 'flex';
      resultsDiv.style.display = 'none';

      // Start scan by POSTing to /async_scan
      fetch('/async_scan', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams({domain})
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'Scan started') {
          resultDomainSpan.textContent = domain;
          startPolling(domain);
        } else {
          alert('Failed to start scan');
          runBtn.disabled = false;
          loadingDiv.style.display = 'none';
        }
      })
      .catch(err => {
        alert('Error starting scan');
        runBtn.disabled = false;
        loadingDiv.style.display = 'none';
      });
    });

    function startPolling(domain) {
      pollInterval = setInterval(() => {
        fetch(`/scan_results/${domain}`)
          .then(res => {
            if (res.status === 404) {
              // No results yet
              return null;
            }
            return res.json();
          })
          .then(data => {
            if (data && data.passive && data.active) {
              clearInterval(pollInterval);
              displayResults(domain, data.passive, data.active);
            }
          })
          .catch(() => {
            // Ignore polling errors for now
          });
      }, 3000); // every 3 seconds
    }

    function displayResults(domain, passive, active) {
      loadingDiv.style.display = 'none';
      runBtn.disabled = false;
      resultsDiv.style.display = 'block';

      // Clear lists
      passiveList.innerHTML = '';
      activeList.innerHTML = '';

      if (passive.length === 0) {
        passiveList.innerHTML = '<li class="list-group-item">No passive subdomains found.</li>';
      } else {
        passive.forEach(sub => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = sub;
          passiveList.appendChild(li);
        });
      }

      if (active.length === 0) {
        activeList.innerHTML = '<li class="list-group-item">No active subdomains found.</li>';
      } else {
        active.forEach(sub => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = sub;
          activeList.appendChild(li);
        });
      }
    }

    rescanBtn.addEventListener('click', () => {
      resultsDiv.style.display = 'none';
      form.reset();
      runBtn.disabled = false;
      loadingDiv.style.display = 'none';
    });
  </script>
  <script>
    const domain = document.getElementById("domain-input").value;

    function pollResults() {
        fetch(`/scan_results/${domain}`)
            .then(res => {
                if (res.status === 404) return null;
                return res.json();
            })
            .then(data => {
                if (data && data.status === "completed") {
                    window.location.href = `/results/${domain}`;
                } else {
                    setTimeout(pollResults, 3000);
                }
            });
    }

    function suspendScan() {
        fetch(`/suspend_scan/${domain}`, { method: "POST" })
            .then(res => res.json())
            .then(data => alert(data.status || data.error));
    }

    document.getElementById("suspend-btn").addEventListener("click", suspendScan);

    pollResults();
  </script>

</body>
</html>
